<mat-card>
    <mat-card-content>
        <app-table
            [data$]="data$"
            [columns]="columns"
            [defaultSort]="{ active: 'request.respondedAt', direction: 'desc' }"
            [paginationConfig]="{
                pageSizeOptions: [10, 25, 50, 100],
                defaultPageSize: 25,
                showFirstLastButtons: true
            }"
            [selectable]="true"
            [multiSelect]="false"
            (selectionChange)="onSelectionChange($event)">

            <!-- Cell Templates -->
            <ng-template #cellTemplate let-element let-column="column">
                <ng-container [ngSwitch]="column.name">
                    <ng-container *ngSwitchCase="'request.message.header.requestId'">
                        <span>{{element.request.message.header.requestId}}</span>
                    </ng-container>

                    <ng-container *ngSwitchCase="'response.message.payload.error.code'">
                        <span class="pill-item" [style.color]="getStatusColor(element)">
                            {{element?.response?.message?.payload?.['error']?.code ?? 'SUCCESS'}}
                        </span>
                    </ng-container>

                    <ng-container *ngSwitchCase="'request.receivedAt'">
                        <span *ngIf="element?.request?.receivedAt">{{element.request.receivedAt | date:'medium'}}</span>
                    </ng-container>

                    <ng-container *ngSwitchCase="'request.respondedAt'">
                        <span *ngIf="element?.request?.respondedAt">{{element.request.respondedAt | date:'medium'}}</span>
                    </ng-container>

                    <ng-container *ngSwitchCase="'meta'">
                        <span class="muted italic ellipsis">{{getMetaText(element)}}</span>
                    </ng-container>

                    <ng-container *ngSwitchDefault>
                        {{getNestedValue(element, column.name)}}
                    </ng-container>
                </ng-container>
            </ng-template>
        </app-table>
    </mat-card-content>
</mat-card>

<mat-card *ngIf="selectedFlow" class="detail-container">
    <mat-card-header>
        <mat-card-title>
            {{ selectedFlow.request.message.header.requestId }}
        </mat-card-title>
        <div class="header-actions">
            <app-export
                [data]="selectedFlow"
                filename="flow-details"
                tooltip="Export Flow Details"
                [customizable]="true"
                [disabled]="!selectedFlow">
            </app-export>
            <button mat-icon-button class="close-button" (click)="closeDetails()" matTooltip="Close details">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </mat-card-header>
    <mat-card-content>
        <mat-tab-group animationDuration="150">
            <mat-tab label="Message Details">
                <div class="tab-content">
                    <!-- Overview Section -->
                    <div class="section">
                        <h3>Overview</h3>
                        <div class="pill-section">
                            <div class="pill-item">
                                <span class="label">Status</span>
                                <span class="value" [style.color]="getStatusColor(selectedFlow)">
                                    {{selectedFlow.response?.message?.payload?.['error']?.code ?? 'SUCCESS'}}
                                </span>
                            </div>
                            <div class="pill-item" matTooltip="When the message broker received the request from the originator">
                                <span class="label">Started</span>
                                <span class="value">{{selectedFlow.request.receivedAt | date:'medium'}}</span>
                            </div>
                            <div class="pill-item" matTooltip="When the target service responded to the request">
                                <span class="label">Completed</span>
                                <span class="value">{{selectedFlow.request.respondedAt | date:'medium'}}</span>
                            </div>
                            <div class="pill-item" matTooltip="Total time from broker receiving the request to getting the response">
                                <span class="label">Total Duration</span>
                                <span class="value">{{getProcessingDuration(selectedFlow)}}ms</span>
                            </div>
                            <div class="pill-item" matTooltip="Maximum time allowed for the responder to send a response">
                                <span class="label">Timeout</span>
                                <span class="value">{{selectedFlow.request.timeout}}ms</span>
                            </div>
                        </div>
                    </div>

                    <!-- Request Section -->
                    <div class="section">
                        <h3>Request</h3>
                        <div class="pill-section">
                            <div class="pill-item service-pill">
                                <span class="label">Originator</span>
                                <span class="value">{{selectedFlow.request.serviceId}}</span>
                            </div>
                            <div class="pill-item">
                                <span class="label">Action</span>
                                <span class="value">{{selectedFlow.request.message.header.action}}</span>
                            </div>
                            <div class="pill-item">
                                <span class="label">Topic</span>
                                <span class="value">{{selectedFlow.request.message.header.topic}}</span>
                            </div>
                            <div class="pill-item">
                                <span class="label">Version</span>
                                <span class="value">{{selectedFlow.request.message.header.version}}</span>
                            </div>
                            <div class="pill-item">
                                <span class="label">Request ID</span>
                                <span class="value">{{selectedFlow.request.message.header.requestId}}</span>
                            </div>
                            <ng-container *ngFor="let item of getHeaderItems(selectedFlow.request.message.header)">
                                <div class="pill-item header-pill" *ngIf="!['action', 'topic', 'version', 'requestId'].includes(item.key)">
                                    <span class="label">{{item.key}}</span>
                                    <span class="value">{{item.value}}</span>
                                </div>
                            </ng-container>
                            <div class="pill-item" matTooltip="Total size of header and payload combined">
                                <span class="label">Size</span>
                                <span class="value">{{getMessageSize(selectedFlow.request.message)}} bytes</span>
                            </div>
                        </div>
                        <div class="expandable-section">
                            <mat-expansion-panel>
                                <mat-expansion-panel-header>
                                    <mat-panel-title>Payload</mat-panel-title>
                                </mat-expansion-panel-header>
                                <pre>{{selectedFlow.request.message.payload | json}}</pre>
                            </mat-expansion-panel>
                        </div>
                    </div>

                    <!-- Response Section -->
                    <div class="section" *ngIf="selectedFlow.response">
                        <h3>Response</h3>
                        <div class="pill-section">
                            <div class="pill-item service-pill">
                                <span class="label">Responder</span>
                                @if (selectedFlow.response.target && !selectedFlow.response.fromBroker) {
                                    <span class="value">{{selectedFlow.response.target.serviceId}}</span>
                                    <span class="property" matTooltip="Higher number means lower priority">Priority: {{selectedFlow.response.target.priority}}</span>
                                } @else if (selectedFlow.response.message) {
                                    <span class="value warning">message-broker</span>
                                }
                            </div>
                            @if (selectedFlow.response.message) {
                                <div class="pill-item">
                                    <span class="label">Action</span>
                                    <span class="value">{{selectedFlow.response.message.header.action}}</span>
                                </div>
                                <div class="pill-item">
                                    <span class="label">Topic</span>
                                    <span class="value">{{selectedFlow.response.message.header.topic}}</span>
                                </div>
                                <div class="pill-item">
                                    <span class="label">Version</span>
                                    <span class="value">{{selectedFlow.response.message.header.version}}</span>
                                </div>
                                <div class="pill-item">
                                    <span class="label">Request ID</span>
                                    <span class="value">{{selectedFlow.response.message.header.requestId}}</span>
                                </div>
                                <ng-container *ngFor="let item of getHeaderItems(selectedFlow.response.message.header)">
                                    <div class="pill-item header-pill" *ngIf="!['action', 'topic', 'version', 'requestId'].includes(item.key)">
                                        <span class="label">{{item.key}}</span>
                                        <span class="value">{{item.value}}</span>
                                    </div>
                                </ng-container>
                                <div class="pill-item" matTooltip="Total size of header and payload combined">
                                    <span class="label">Size</span>
                                    <span class="value">{{getMessageSize(selectedFlow.response.message)}} bytes</span>
                                </div>
                            }
                        </div>
                        <div class="expandable-section" *ngIf="selectedFlow.response.message">
                            <mat-expansion-panel>
                                <mat-expansion-panel-header>
                                    <mat-panel-title>Payload</mat-panel-title>
                                </mat-expansion-panel-header>
                                <pre>{{selectedFlow.response.message.payload | json}}</pre>
                            </mat-expansion-panel>
                        </div>
                    </div>

                    <!-- Auditors Section -->
                    <div class="section" *ngIf="selectedFlow.auditors?.length">
                        <h3>Auditors</h3>
                        <div class="pill-section">
                            <div class="pill-item" *ngFor="let serviceId of selectedFlow.auditors"
                                matTooltip="Services that receive a copy of the message but don't respond">
                                <span class="label">Service</span>
                                <span class="value">{{serviceId}}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Error Details Section (if error) -->
                    <div class="section" *ngIf="selectedFlow.response?.message?.payload?.['error']">
                        <h3>Error Details</h3>
                        <div class="pill-section">
                            <div class="pill-item error-pill">
                                <span class="label">Error Code</span>
                                <span class="value">{{selectedFlow.response?.message?.payload?.['error']?.code}}</span>
                                <span class="property">{{selectedFlow.response?.message?.payload?.['error']?.message}}</span>
                                <ng-container *ngIf="selectedFlow.response?.message?.payload?.['error']?.metadata">
                                    <span class="property" *ngFor="let item of getHeaderItems(selectedFlow.response?.message?.payload?.['error']?.metadata)">
                                        {{item.key}}: {{item.value}}
                                    </span>
                                </ng-container>
                            </div>
                        </div>
                    </div>

                    <!-- Message Chain Section -->
                    <div class="section" *ngIf="selectedFlow.parentRequestId || selectedFlow.childRequestIds?.length">
                        <h3>Message Chain</h3>
                        <div class="pill-section">
                            <div class="pill-item" *ngIf="selectedFlow.parentRequestId">
                                <span class="label">Parent Request</span>
                                <span class="value">{{selectedFlow.parentRequestId}}</span>
                            </div>
                            <ng-container *ngIf="selectedFlow.childRequestIds?.length">
                                <div class="pill-item" *ngFor="let childId of selectedFlow.childRequestIds">
                                    <span class="label">Child Request</span>
                                    <span class="value">{{childId}}</span>
                                </div>
                            </ng-container>
                        </div>
                    </div>

                    <!-- Related Messages Section -->
                    <div class="section" *ngIf="selectedFlow.relatedMessages?.length">
                        <h3>Related Messages</h3>
                        <div class="pill-section">
                            <div class="pill-item message-pill" *ngFor="let msg of selectedFlow.relatedMessages"
                                matTooltip="Messages that were triggered as a result of processing this request">
                                <span class="label">{{msg.header.action}}</span>
                                <span class="value">{{msg.header.topic}}</span>
                                @if (msg.header.requestId) {
                                    <span class="property">Request ID: {{msg.header.requestId}}</span>
                                }
                                @for (target of msg.targetServiceIds; track target) {
                                    <span class="property">To: {{target}}</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <mat-tab label="Flow Diagram">
                <div class="tab-content">
                    <div class="section">
                        <app-flow-diagram [messageFlow]="selectedFlow"></app-flow-diagram>
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-card-content>
</mat-card>