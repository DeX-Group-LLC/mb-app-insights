<div class="diagram-container">
    <svg #svgContainer [attr.width]="width" [attr.height]="height" class="flow-diagram"
        [attr.viewBox]="'0 0 ' + width + ' ' + height"
        preserveAspectRatio="xMidYMin slice">
        <!-- Definitions for symbols -->
        <defs>
            <!-- Error symbol (X) -->
            <symbol id="error-symbol" viewBox="-6 -6 12 12">
                <path d="M-4,-4 L4,4 M-4,4 L4,-4"
                    stroke="currentColor"
                    stroke-width="2"
                    fill="none"/>
            </symbol>
            <!-- Timeout symbol (clock) -->
            <symbol id="timeout-symbol" viewBox="-6 -6 12 12">
                <circle r="5"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"/>
                <path d="M0,-3 L0,0 L2,2"
                    stroke="currentColor"
                    stroke-width="1.5"
                    fill="none"/>
            </symbol>
            <!-- Dropped symbol (stop) -->
            <symbol id="dropped-symbol" viewBox="-6 -6 12 12">
                <rect x="-4" y="-4" width="8" height="8"
                    stroke="currentColor"
                    stroke-width="1.5"
                    fill="none"/>
                <line x1="-2" y1="-2" x2="2" y2="2"
                    stroke="currentColor"
                    stroke-width="1.5"/>
                <line x1="-2" y1="2" x2="2" y2="-2"
                    stroke="currentColor"
                    stroke-width="1.5"/>
            </symbol>
        </defs>

        <!-- Lifelines first (bottom layer) -->
        <ng-container *ngFor="let node of flowData?.nodes">
            <line *ngIf="node.type !== 'listener'"
                [attr.x1]="node.x" [attr.y1]="node.y + 24" [attr.x2]="node.x" [attr.y2]="height - 10"
                class="lifeline" />
        </ng-container>

        <!-- Messages next (middle layer) -->
        <ng-container *ngFor="let msg of flowData?.messages; let i = index">
            <g [attr.transform]="'translate(0,' + (60 + i * 30 + 16) + ')'"
               [matTooltip]="getMessageTooltip(msg)"
               [matTooltipClass]="'flow-message-tooltip'"
               [class.clickable]="isMessageClickable(msg)"
               (click)="onMessageClick(msg)">
                <!-- Arrow Line -->
                <line [attr.x1]="getNodeX(msg.from)" [attr.x2]="getNodeX(msg.to)" y1="0" y2="0"
                    [class]="'message-line ' + msg.type + ' ' + (msg.status || '') + (msg.isBrokerInput ? ' isBrokerInput' : '')" />

                <!-- Arrow Head -->
                <path [attr.d]="getArrowPath(getNodeX(msg.from), getNodeX(msg.to), 0)"
                    [class]="'message-arrow ' + msg.type + ' ' + (msg.status || '')" />

                <!-- Status Symbol -->
                <foreignObject [attr.x]="getNodeX(msg.from) - 8" y="-8" width="80" height="16" *ngIf="msg.status">
                    <div class="status-icon-container">
                        <mat-icon [class]="'material-symbols-outlined status-symbol ' + msg.status">{{getStatusIcon(msg.status)}}</mat-icon>
                        <span [class]="'status-text ' + msg.status">{{msg.status}}</span>
                    </div>
                </foreignObject>

                <!-- Message Label -->
                <foreignObject [attr.x]="(getNodeX(msg.from) + getNodeX(msg.to)) / 2 - 75" y="-13" width="150" height="20">
                    <div class="message-label">{{msg.label}}</div>
                </foreignObject>

                <!-- Timestamp -->
                <foreignObject [attr.x]="(getNodeX(msg.from) + getNodeX(msg.to)) / 2 - 50" y="0" width="100" height="20">
                    <div class="timestamp">{{msg.timestamp | date:'HH:mm:ss.SSS'}}</div>
                </foreignObject>
            </g>
        </ng-container>

        <!-- Service boxes last (top layer) -->
        <ng-container *ngFor="let node of flowData?.nodes">
            <g [class]="'service-group ' + node.type">
                <rect [attr.x]="node.x - 50" [attr.y]="node.y" width="100" height="24" rx="4"
                    class="service-box" />
                <foreignObject [attr.x]="node.x - 50" [attr.y]="node.y" width="100" height="24">
                    <div class="service-label" matTooltip="{{node.label}}">{{node.label}}</div>
                </foreignObject>
            </g>
        </ng-container>
    </svg>
</div>